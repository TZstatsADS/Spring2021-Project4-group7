---
title: "R Notebook"
output: html_notebook
---

This is an [R Markdown](http://rmarkdown.rstudio.com) Notebook. When you execute code within the notebook, the results appear beneath the code. 

Try executing this chunk by clicking the *Run* button within the chunk or by placing your cursor inside it and pressing ####weighted reg

```{r load data}
lowDim <- read_csv('../data/lowDim_dataset.csv')
highDim <- read_csv('../data/highDim_dataset.csv') 
```

```{r prep data reg estimate}
df_ld <- lowDim %>% mutate(A = factor(A))
df_hd <- highDim %>% mutate(A = factor(A))
```

```{r}
X_low <- df_ld %>% select(-Y, -A) %>% as.matrix
A_low <- df_ld %>% select(A) %>% as.matrix
X_high <- df_hd %>% select(-Y, -A) %>% as.matrix
A_high <- df_hd %>% select(A) %>% as.matrix
cv_L2_low <- cv.glmnet(X_low, A_low, family = "binomial", alpha = 0)
cv_L2_high <- cv.glmnet(X_high, A_high, family = "binomial", alpha = 0)
```

```{r}
#L2 to get propensity score -low 
L2_low <- glmnet(X_low, A_low, family = "binomial",
                 alpha = 0, lambda = cv_L2$lambda.min)
propensity_score_low <- predict(L2_low, X_low, type = "response")
```

```{r weighted regression - low dim}
# Finding weights - low
t<- as.numeric(A_low)
wt_low <- t/(propensity_score_low) + (1-t)/(1-propensity_score_low)
# Estimate linear regression - low dim:
model_low <- lm(Y~., data = df_ld)
feature_z_low <- summary(model_low)$coef[,4][3:24]<0.05
Y <- df_ld$Y
Z_low <- as.data.frame(cbind(A_low,X_low[,feature_z_low]))
Z_low<-sapply(Z_low, as.numeric)
weighted_low <- lm(Y ~ Z_low, weights = wt_low)
#coef of T is an estimate for ATE
ATE_low <- coef(weighted_low)[2]
ATE_low
```

```{r}
#L2 to get propensity score - high
L2_high <- glmnet(X_high, A_high, family = "binomial",alpha = 0, lambda = cv_L2_high$lambda.min)
propensity_score_high <- predict(L2_high, X_high, type = "response")
```

```{r weighted regression - high dim}
# Finding weights - high
t<- as.numeric(A_high)
wt_high <- t/(propensity_score_high) + (1-t)/(1-propensity_score_high)
# Estimate linear regression - high dim:
model_high <- lm(Y~., data = df_hd)
feature_z_high <- summary(model_high)$coef[,4][3:187]<0.05
Y <- df_hd$Y
Z_high <- as.data.frame(cbind(A_high,X_high[,feature_z_high]))
Z_high<-sapply(Z_high, as.numeric)
weighted_high <- lm(Y ~ Z_high, weights = wt_high)
#coef of T is an estimate for ATE
ATE_high <- coef(weighted_high)[2]
ATE_high
```
